<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ESP32 智能门锁控制中心</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>ESP32 智能门锁控制中心</h1>
    </div>

    <div class="content">
        <!-- 首页页面 -->
        <div id="home-page" class="page-container active">
            <div class="card">
                <div class="icon-box">
                    <div class="lock-icon"></div>
                    <div class="status-text">门锁已锁定</div>
                </div>
                <div class="card-title">设备状态</div>
                <div class="status-item">
                    <label>设备名称</label>
                    <span class="value">ESP32 智能门锁</span>
                </div>
                <div class="status-item">
                    <label>连接状态</label>
                    <span class="value"><span class="status-tag status-normal">正常</span></span>
                </div>
                <div class="status-item">
                    <label>固件版本</label>
                    <span class="value">v1.2.0</span>
                </div>
            </div>
        </div>

        <!-- 卡号库页面 -->
        <div id="card-page" class="page-container">
            <div class="card">
                <div class="card-title">卡号库管理</div>
                <div class="status-item">
                    <label>已添加卡片</label>
                    <span class="value" id="card-count">0 张</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-add" id="add-card">
                    <i>+</i>添加卡片
                </button>
                <button class="btn btn-empty" id="empty-card">
                    <i>✕</i>清空卡片
                </button>
                <button class="btn btn-refresh" id="refresh-cards">
                    <i>↺</i>刷新
                </button>
            </div>

            <div class="card">
                <div class="list-container" id="card-list-container">
                    <div class="empty-state">
                        <i>💳</i>
                        <p>暂无卡片数据</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 指纹库页面 -->
        <div id="fingerprint-page" class="page-container">
            <div class="card">
                <div class="card-title">指纹库管理</div>
                <div class="status-item">
                    <label>已录入指纹</label>
                    <span class="value" id="fingerprint-count">0 枚</span>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-add" id="add-fingerprint">
                    <i>+</i>录入指纹
                </button>
                <button class="btn btn-empty" id="empty-fingerprint">
                    <i>✕</i>清空指纹
                </button>
                <button class="btn btn-refresh" id="refresh-fingerprints">
                    <i>↺</i>刷新
                </button>
            </div>

            <div class="card">
                <div class="list-container" id="fingerprint-list-container">
                    <div class="empty-state">
                        <i>👆</i>
                        <p>暂无指纹数据</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 我的页面 -->
        <div id="mine-page" class="page-container">
            <div class="card">
                <div class="card-title">系统设置</div>
                <div class="status-item">
                    <label>WiFi名称</label>
                    <input type="text" name="wifi-name" placeholder="请输入WiFi名称">
                </div>
                <div class="status-item">
                    <label>WiFi密码</label>
                    <input type="password" name="wifi-password" placeholder="请输入WiFi密码">
                </div>
                <div class="status-item">
                    <label>门锁密码</label>
                    <input type="password" name="lock-password" placeholder="请输入门锁密码">
                </div>
                <button class="btn btn-operation">确认修改</button>
                <button class="btn btn-operation">设备信息</button>
                <button class="btn btn-operation">关于系统</button>
            </div>
        </div>
    </div>

    <!-- 删除确认弹窗 -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <p>确定要删除该项目吗？</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="confirm-delete">确认</button>
                <button class="modal-btn modal-cancel" id="cancel-delete">取消</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item active" data-page="home-page">
            <span class="icon">🏠</span>
            <span>首页</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="card-page">
            <span class="icon">💳</span>
            <span>卡号库</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="fingerprint-page">
            <span class="icon">👆</span>
            <span>指纹库</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="mine-page">
            <span class="icon">👤</span>
            <span>我的</span>
        </a>
    </div>

    <script>
















        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;

        // 初始化WebSocket连接
        function initWebSocket() {
            console.log('尝试建立WebSocket连接...');
            websocket = new WebSocket(gateway);

            websocket.onopen = function (event) {
                console.log('WebSocket连接已打开');
                document.querySelector('.status-tag').className = 'status-tag status-normal';






                document.querySelector('.status-tag').textContent = '正常';
            };


            websocket.onclose = function (event) {
                console.log('WebSocket连接已关闭，2秒后重试...');






                document.querySelector('.status-tag').textContent = '断开';
                setTimeout(initWebSocket, 2000); // 2秒后重连


            };


            websocket.onerror = function (error) {
                console.error('WebSocket错误:', error);

                document.querySelector('.status-tag').textContent = '错误';
            };



        }


        // 发送命令到ESP32
        function sendCommand(command) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {



                websocket.send(command);





                console.log('发送命令:', command);
                return true;
            } else {
                console.error('WebSocket未连接，无法发送命令');
                alert('设备连接已断开，请稍后重试');
                return false;
            }
        }


        // 页面导航控制
        const Navigation = {
            init() {
                this.navItems = document.querySelectorAll('.nav-item');
                this.pageContainers = document.querySelectorAll('.page-container');
                this.bindEvents();
            },

            bindEvents() {
                this.navItems.forEach(item => {
                    item.addEventListener('click', () => this.switchPage(item));
                });
            },

            switchPage(item) {
                const targetPageId = item.getAttribute('data-page');
                this.navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                this.pageContainers.forEach(page => {
                    page.classList.toggle('active', page.id === targetPageId);
                });
            }
        };

        // 弹窗控制
        const Modal = {
            init() {
                this.modal = document.getElementById('delete-modal');
                this.confirmBtn = document.getElementById('confirm-delete');
                this.cancelBtn = document.getElementById('cancel-delete');
                this.itemToDelete = null;
                this.deleteType = '';
                this.deleteAction = '';
                this.bindEvents();
            },

            bindEvents() {
                this.confirmBtn.addEventListener('click', () => this.handleConfirm());
                this.cancelBtn.addEventListener('click', () => this.hide());
                this.modal.addEventListener('click', (e) => {
                    if (e.target === this.modal) this.hide();
                });
            },

            showDeleteConfirm(type, id = null, action = 'delete') {
                this.deleteType = type;
                this.itemToDelete = id;
                this.deleteAction = action;
                const modalText = action === 'clear'
                    ? `确定要清空所有${type === 'card' ? '卡片' : '指纹'}吗？`
                    : '确定要删除该项目吗？';
                document.querySelector('.modal-content p').textContent = modalText;
                this.modal.style.display = 'flex';
            },

            hide() {
                this.modal.style.display = 'none';
                this.itemToDelete = null;
                this.deleteType = '';
                this.deleteAction = '';
            },

            handleConfirm() {
                if (this.deleteAction === 'clear') {
                    const command = this.deleteType === 'card' ? 'clear_cards' : 'clear_fingerprints';
                    WebSocketManager.sendCommand(command);
                }
                this.hide();
            }
        };

        // 主应用控制器
        const App = {
            init() {
                initWebSocket(); // 使用新的WebSocket初始化函数
                Navigation.init();
                Modal.init();
                this.bindActionButtons();
            },

            bindActionButtons() {
                // 卡片管理按钮
                document.getElementById('add-card').addEventListener('click', () => {
                    sendCommand('add_card'); // 使用新的发送函数
                });

                document.getElementById('empty-card').addEventListener('click', () => {
                    Modal.showDeleteConfirm('card', null, 'clear');
                });

                document.getElementById('refresh-cards').addEventListener('click', () => {
                    sendCommand('refresh_cards');
                });

                // 指纹管理按钮
                document.getElementById('add-fingerprint').addEventListener('click', () => {
                    sendCommand('add_fingerprint');
                });

                document.getElementById('empty-fingerprint').addEventListener('click', () => {
                    Modal.showDeleteConfirm('fingerprint', null, 'clear');
                });

                document.getElementById('refresh-fingerprints').addEventListener('click', () => {
                    sendCommand('refresh_fingerprints');
                });
            }
        };

        // 弹窗确认按钮处理
        document.getElementById('confirm-delete').addEventListener('click', () => {
            if (Modal.deleteAction === 'clear') {
                const command = Modal.deleteType === 'card' ? 'clear_cards' : 'clear_fingerprints';
                sendCommand(command);
            }
            Modal.hide();
        });

        // 初始化应用
        window.addEventListener('load', () => {
            App.init();
        });
    </script>
</body>

</html>