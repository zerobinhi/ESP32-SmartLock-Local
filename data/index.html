<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>ESP32 æ™ºèƒ½é—¨é”æ§åˆ¶ä¸­å¿ƒ</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div class="topnav">
		<h1>ESP32 æ™ºèƒ½é—¨é”æ§åˆ¶ä¸­å¿ƒ</h1>
		<div class="connection-status" id="connection-status" title="è¿æ¥çŠ¶æ€"></div>
	</div>
	<div class="content">
		<!-- é¦–é¡µé¡µé¢ -->
		<div id="home-page" class="page-container active">
			<div class="card">
				<div class="icon-box">
					<div class="lock-icon"></div>
				</div>
				<div class="card-title">è®¾å¤‡ä¿¡æ¯</div>
				<div class="status-item">
					<label>æŒ‡çº¹æ•°é‡</label>
					<span class="value" id="home-fingerprint-count">-</span>
				</div>
				<div class="status-item">
					<label>å¡å·æ•°é‡</label>
					<span class="value" id="home-card-count">-</span>
				</div>
				<div class="status-item">
					<label>å›ºä»¶ç‰ˆæœ¬</label>
					<span class="value" id="firmware-version">-</span>
				</div>
			</div>
		</div>
		<!-- å¡å·åº“é¡µé¢ -->
		<div id="card-page" class="page-container">
			<div class="card">
				<div class="card-title">å¡å·åº“ç®¡ç†</div>
				<div class="status-item">
					<label>å·²æ·»åŠ å¡ç‰‡</label>
					<span class="value" id="card-count">0 å¼ </span>
				</div>
			</div>
			<div class="btn-group">
				<button class="btn btn-add" id="add-card">
					<i>+</i>æ·»åŠ å¡ç‰‡
				</button>
				<button class="btn btn-empty" id="empty-card">
					<i>âœ•</i>æ¸…ç©ºå¡ç‰‡
				</button>
				<button class="btn btn-refresh" id="refresh-cards">
					<i>â†º</i>åˆ·æ–°
				</button>
			</div>
			<div class="card">
				<div class="list-container" id="card-list-container">
					<div class="empty-state">
						<i>ğŸ’³</i>
						<p>æš‚æ— å¡ç‰‡æ•°æ®</p>
					</div>
				</div>
			</div>
		</div>
		<!-- æŒ‡çº¹åº“é¡µé¢ -->
		<div id="fingerprint-page" class="page-container">
			<div class="card">
				<div class="card-title">æŒ‡çº¹åº“ç®¡ç†</div>
				<div class="status-item">
					<label>å·²å½•å…¥æŒ‡çº¹</label>
					<span class="value" id="fingerprint-count">0 æš</span>
				</div>
			</div>
			<div class="btn-group">
				<button class="btn btn-add" id="add-fingerprint">
					<i>+</i>å½•å…¥æŒ‡çº¹
				</button>
				<button class="btn btn-empty" id="empty-fingerprint">
					<i>âœ•</i>æ¸…ç©ºæŒ‡çº¹
				</button>
				<button class="btn btn-refresh" id="refresh-fingerprints">
					<i>â†º</i>åˆ·æ–°
				</button>
			</div>
			<div class="card">
				<div class="list-container" id="fingerprint-list-container">
					<div class="empty-state">
						<i>ğŸ‘†</i>
						<p>æš‚æ— æŒ‡çº¹æ•°æ®</p>
					</div>
				</div>
			</div>
		</div>
		<!-- æˆ‘çš„é¡µé¢ -->
		<div id="mine-page" class="page-container">
			<div class="card">
				<div class="card-title">ç³»ç»Ÿè®¾ç½®</div>
				<div class="status-item">
					<label>WiFiåç§°ï¼š</label>
					<div class="input-container">
						<input type="text" id="wifi-name" placeholder="ä»…å…è®¸è‹±æ–‡æˆ–æ•°å­—">
					</div>
				</div>
				<div class="status-item">
					<label>WiFiå¯†ç ï¼š</label>
					<div class="input-container">
						<input type="password" id="wifi-password" placeholder="ä»…å…è®¸è‹±æ–‡æˆ–æ•°å­—ï¼Œæœ€å°‘8ä½" maxlength="16">
					</div>
				</div>
				<div class="status-item">
					<label>é—¨é”å¯†ç ï¼š</label>
					<div class="input-container">
						<input type="password" id="lock-password" placeholder="è¯·è¾“å…¥6ä½æ•°å­—" maxlength="6">
					</div>
				</div>
				<button class="btn btn-operation" id="save-settings">ç¡®è®¤ä¿®æ”¹</button>
				<button class="btn btn-operation" id="device-info">è®¾å¤‡ä¿¡æ¯</button>
				<button class="btn btn-operation" id="about-system">å…³äºç³»ç»Ÿ</button>
				<div style="height: 12px;"></div>
			</div>
		</div>
	</div>
	<!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
	<div class="modal" id="delete-modal">
		<div class="modal-content">
			<p>ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ</p>
			<div class="modal-buttons">
				<button class="modal-btn modal-confirm" id="confirm-delete">ç¡®è®¤</button>
				<button class="modal-btn modal-cancel" id="cancel-delete">å–æ¶ˆ</button>
			</div>
		</div>
	</div>
	<!-- æç¤ºå¼¹çª— -->
	<div class="modal" id="alert-modal">
		<div class="modal-content">
			<p id="alert-message"></p>
			<div class="modal-buttons">
				<button class="modal-btn modal-confirm" id="confirm-alert">ç¡®è®¤</button>
			</div>
		</div>
	</div>
	<!-- æˆåŠŸå¼¹çª— -->
	<div class="modal" id="success-toast-modal">
		<div class="toast-box success-toast-box">
			<div class="success-icon">âœ“</div>
			<p id="success-message"></p>
		</div>
	</div>
	<!-- åŠ è½½ä¸­å¼¹çª— -->
	<div class="modal" id="loading-modal">
		<div class="toast-box loading-box">
			<div class="loading-spinner"></div>
			<p class="loading-text">åŠ è½½ä¸­...</p>
		</div>
	</div>
	<!-- åº•éƒ¨å¯¼èˆª -->
	<div class="bottom-nav">
		<a href="javascript:void(0)" class="nav-item active" data-page="home-page">
			<span class="icon">ğŸ </span>
			<span>é¦–é¡µ</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="card-page">
			<span class="icon">ğŸ’³</span>
			<span>å¡å·åº“</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="fingerprint-page">
			<span class="icon">ğŸ‘†</span>
			<span>æŒ‡çº¹åº“</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="mine-page">
			<span class="icon">ğŸ‘¤</span>
			<span>æˆ‘çš„</span>
		</a>
	</div>
	<script>
		// ==================== å…¨å±€å˜é‡ ====================
		const gateway = `ws://${window.location.hostname}/ws`;
		let websocket;
		let cardData = [];
		let fingerprintData = [];
		let reconnectTimer = null;
		let loadingTimer = null;

		// ==================== å·¥å…·å‡½æ•° ====================
		// é˜²æŠ–å‡½æ•°
		function debounce(func, wait) {
			let timeout;
			return function (...args) {
				clearTimeout(timeout);
				timeout = setTimeout(() => func.apply(this, args), wait);
			};
		}

		// è§¦è§‰åé¦ˆ
		function hapticFeedback(duration = 50) {
			if (navigator.vibrate) {
				navigator.vibrate(duration);
			}
		}

		// å®‰å…¨å‘é€WebSocketæ¶ˆæ¯
		function sendMessage(message) {
			if (websocket && websocket.readyState === WebSocket.OPEN) {
				websocket.send(message);
				return true;
			} else {
				showAlert('è®¾å¤‡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'å¥½çš„');
				return false;
			}
		}

		// ==================== WebSocket ====================
		window.addEventListener('load', onLoad);

		function initWebSocket() {
			console.log('æ­£åœ¨è¿æ¥WebSocket...');
			websocket = new WebSocket(gateway);
			websocket.onopen = onOpen;
			websocket.onclose = onClose;
			websocket.onmessage = onMessage;
			websocket.onerror = onError;
		}

		function onOpen(event) {
			console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
			updateConnectionStatus(true);
			clearTimeout(reconnectTimer);
		}

		function onClose(event) {
			console.log('âŒ WebSocketè¿æ¥æ–­å¼€');
			updateConnectionStatus(false);
			// è‡ªåŠ¨é‡è¿
			reconnectTimer = setTimeout(() => {
				console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥...');
				initWebSocket();
			}, 2000);
		}

		function onError(event) {
			console.error('WebSocketé”™è¯¯:', event);
			updateConnectionStatus(false);
		}

		function onMessage(event) {
			try {
				const data = JSON.parse(event.data);
				console.log('ğŸ“¨ æ”¶åˆ°ESP32æ•°æ®:', data);

				switch (data.type) {
					case 'card_list':
						updateCardData(data.data);
						break;
					case 'fingerprint_list':
						updateFingerprintData(data.data);
						break;
					case 'status':
						showSuccessToast(data.message);
						break;
					case 'init_data':
						updateVersion(data.version);
						updateCardData(data.cards);
						updateFingerprintData(data.fingers);
						break;
					case 'operation_result':
						handleOperationResult(data);
						break;
					default:
						console.log('âš ï¸ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
				}
			} catch (error) {
				console.error('âŒ æ¶ˆæ¯è§£æé”™è¯¯:', error);
				showAlert('æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•', 'ç¡®å®š');
			}
		}

		// å¤„ç†æ“ä½œç»“æœ
		function handleOperationResult(data) {
			const operations = {
				'fingerprint_added': { success: 'æŒ‡çº¹æ·»åŠ æˆåŠŸ', fail: 'æŒ‡çº¹æ·»åŠ å¤±è´¥' },
				'card_added': { success: 'å¡ç‰‡æ·»åŠ æˆåŠŸ', fail: 'å¡ç‰‡å·²å­˜åœ¨' },
				'fingerprint_deleted': { success: 'æŒ‡çº¹åˆ é™¤æˆåŠŸ', fail: 'æŒ‡çº¹åˆ é™¤å¤±è´¥' },
				'card_deleted': { success: 'å¡ç‰‡åˆ é™¤æˆåŠŸ', fail: 'å¡ç‰‡åˆ é™¤å¤±è´¥' },
				'fingerprint_cleared': { success: 'æŒ‡çº¹æ¸…ç©ºæˆåŠŸ', fail: 'æŒ‡çº¹æ¸…ç©ºå¤±è´¥' },
				'card_cleared': { success: 'å¡ç‰‡æ¸…ç©ºæˆåŠŸ', fail: 'å¡ç‰‡æ¸…ç©ºå¤±è´¥' }
			};

			const operation = operations[data.message];
			if (!operation) return;

			if (data.result) {
				Modal.hideAlertModal();
				showSuccessToast(operation.success);

				// æ¸…ç©ºæ“ä½œéœ€è¦æ›´æ–°åˆ—è¡¨
				if (data.message === 'fingerprint_cleared') {
					fingerprintData = [];
					Modal.updateFingerprintList();
					Modal.updateFingerprintCount();
				} else if (data.message === 'card_cleared') {
					cardData = [];
					Modal.updateCardList();
					Modal.updateCardCount();
				}
			} else {
				showAlert(operation.fail, 'å¥½çš„');
			}
		}

		// æ›´æ–°è¿æ¥çŠ¶æ€
		function updateConnectionStatus(connected) {
			const statusEl = document.getElementById('connection-status');
			statusEl.className = 'connection-status ' + (connected ? 'connected' : 'disconnected');
			statusEl.title = connected ? 'è®¾å¤‡å·²è¿æ¥' : 'è®¾å¤‡æœªè¿æ¥';
		}

		// ==================== æ•°æ®æ›´æ–° ====================
		function updateVersion(version) {
			document.getElementById('firmware-version').textContent = `v${version}`;
		}

		function updateCardData(newCards) {
			cardData = newCards || [];
			Modal.updateCardList();
			Modal.updateCardCount();
		}

		function updateFingerprintData(newFingerprints) {
			fingerprintData = newFingerprints || [];
			Modal.updateFingerprintList();
			Modal.updateFingerprintCount();
		}

		// ==================== é¡µé¢åˆå§‹åŒ– ====================
		function onLoad(event) {
			initWebSocket();
			Navigation.init();
			Modal.init();
			initInputValidation();
			initButtonHandlers();
		}

		// ==================== è¾“å…¥éªŒè¯ ====================
		function initInputValidation() {
			const wifiNameInput = document.getElementById('wifi-name');
			const wifiPasswordInput = document.getElementById('wifi-password');
			const lockPasswordInput = document.getElementById('lock-password');

			wifiNameInput.addEventListener('input', debounce(function (e) {
				validateWifiName(e.target);
			}, 300));

			wifiPasswordInput.addEventListener('input', debounce(function (e) {
				validateWifiPassword(e.target);
			}, 300));

			lockPasswordInput.addEventListener('input', debounce(function (e) {
				validateLockPassword(e.target);
			}, 300));
		}

		function validateWifiName(input) {
			input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
			const messageEl = document.getElementById('wifi-name-message');
			if (input.value.length === 0) {
				messageEl.textContent = '';
			} else {
				messageEl.textContent = 'âœ“ æ ¼å¼æ­£ç¡®';
				messageEl.style.color = '#27ae60';
			}
		}

		function validateWifiPassword(input) {
			input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
			const messageEl = document.getElementById('wifi-password-message');
			const hasLetter = /[A-Za-z]/.test(input.value);
			const hasNumber = /[0-9]/.test(input.value);

			if (input.value.length === 0) {
				messageEl.textContent = '';
			} else if (input.value.length < 8) {
				messageEl.textContent = `è¿˜éœ€${8 - input.value.length}ä½`;
				messageEl.style.color = '#f39c12';
			} else if (hasLetter && hasNumber) {
				messageEl.textContent = 'âœ“ å¼ºå¯†ç ';
				messageEl.style.color = '#27ae60';
			} else {
				messageEl.textContent = 'âœ“ æ ¼å¼æ­£ç¡®';
				messageEl.style.color = '#27ae60';
			}
		}

		function validateLockPassword(input) {
			input.value = input.value.replace(/[^0-9]/g, '');
			const messageEl = document.getElementById('lock-password-message');

			if (input.value.length === 0) {
				messageEl.textContent = '';
			} else if (input.value.length < 6) {
				messageEl.textContent = `è¿˜éœ€${6 - input.value.length}ä½`;
				messageEl.style.color = '#f39c12';
			} else {
				messageEl.textContent = 'âœ“ æ ¼å¼æ­£ç¡®';
				messageEl.style.color = '#27ae60';
			}
		}

		// ==================== æŒ‰é’®å¤„ç† ====================
		function initButtonHandlers() {
			// æ·»åŠ è§¦è§‰åé¦ˆ
			document.querySelectorAll('.btn').forEach(btn => {
				btn.addEventListener('click', () => hapticFeedback());
			});

			// ä¿å­˜è®¾ç½®
			document.getElementById('save-settings').addEventListener('click', saveSettings);

			// è®¾å¤‡ä¿¡æ¯
			document.getElementById('device-info').addEventListener('click', () => {
				const version = document.getElementById('firmware-version').textContent;
				const fingerCount = document.getElementById('home-fingerprint-count').textContent;
				const cardCount = document.getElementById('home-card-count').textContent;
				showAlert(`å›ºä»¶ç‰ˆæœ¬: ${version}\næŒ‡çº¹æ•°é‡: ${fingerCount}\nå¡ç‰‡æ•°é‡: ${cardCount}`, 'ç¡®å®š');
			});

			// å…³äºç³»ç»Ÿ
			document.getElementById('about-system').addEventListener('click', () => {
				showAlert('ESP32æ™ºèƒ½é—¨é”ç³»ç»Ÿ\nç‰ˆæœ¬: 1.0.0\nÂ© 2024 All Rights Reserved', 'ç¡®å®š');
			});
		}

		function saveSettings() {
			const wifiName = document.getElementById('wifi-name').value;
			const wifiPassword = document.getElementById('wifi-password').value;
			const lockPassword = document.getElementById('lock-password').value;

			// éªŒè¯
			if (wifiName.length === 0) {
				showAlert('WiFiåç§°ä¸èƒ½ä¸ºç©º', 'å¥½çš„');
				return;
			}
			if (wifiPassword.length > 0 && wifiPassword.length < 8) {
				showAlert('WiFiå¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½', 'å¥½çš„');
				return;
			}
			if (lockPassword.length > 0 && lockPassword.length !== 6) {
				showAlert('é—¨é”å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—', 'å¥½çš„');
				return;
			}

			if (sendMessage(`save_settings:${wifiName},${wifiPassword},${lockPassword}`)) {
				showSuccessToast('è®¾ç½®å·²ä¿å­˜');
				// æ¸…ç©ºè¾“å…¥æ¡†
				document.getElementById('wifi-name').value = '';
				document.getElementById('wifi-password').value = '';
				document.getElementById('lock-password').value = '';
				document.getElementById('wifi-name-message').textContent = '';
				document.getElementById('wifi-password-message').textContent = '';
				document.getElementById('lock-password-message').textContent = '';
			}
		}

		// ==================== å¼¹çª—å‡½æ•° ====================
		function showAlert(message, buttonText = 'ç¡®è®¤', onConfirm = null) {
			const alertModal = document.getElementById('alert-modal');
			const alertMessage = document.getElementById('alert-message');
			const confirmButton = document.getElementById('confirm-alert');

			alertMessage.textContent = message;
			confirmButton.textContent = buttonText;
			alertModal.style.display = 'flex';
			Modal.onAlertConfirm = onConfirm;
		}

		function showSuccessToast(message, duration = 1500) {
			const modal = document.getElementById('success-toast-modal');
			const msgEl = document.getElementById('success-message');
			msgEl.textContent = message;
			modal.style.display = 'flex';

			setTimeout(() => {
				modal.style.display = 'none';
			}, duration);
		}

		function showLoading(message = "åŠ è½½ä¸­...", duration = 5000) {
			const modal = document.getElementById('loading-modal');
			const msgEl = modal.querySelector('.loading-text');
			msgEl.textContent = message;
			modal.style.display = 'flex';

			clearTimeout(loadingTimer);
			loadingTimer = setTimeout(() => {
				modal.style.display = 'none';
				if (duration > 3000) {
					showAlert('æ“ä½œè¶…æ—¶ï¼Œè¯·é‡è¯•', 'å¥½çš„');
				}
			}, duration);
		}

		function hideLoading() {
			clearTimeout(loadingTimer);
			document.getElementById('loading-modal').style.display = 'none';
		}

		// ==================== é¡µé¢å¯¼èˆªæ§åˆ¶ ====================
		const Navigation = {
			init() {
				this.navItems = document.querySelectorAll('.nav-item');
				this.pageContainers = document.querySelectorAll('.page-container');
				this.bindEvents();
			},
			bindEvents() {
				this.navItems.forEach(item => {
					item.addEventListener('click', () => {
						hapticFeedback(30);
						this.switchPage(item);
					});
				});
			},
			switchPage(item) {
				const targetPageId = item.getAttribute('data-page');
				this.navItems.forEach(nav => nav.classList.remove('active'));
				item.classList.add('active');
				this.pageContainers.forEach(page => {
					page.classList.toggle('active', page.id === targetPageId);
				});
			}
		};

		// ==================== å¼¹çª—æ§åˆ¶ ====================
		const Modal = {
			init() {
				this.deleteModal = document.getElementById('delete-modal');
				this.confirmDeleteBtn = document.getElementById('confirm-delete');
				this.cancelDeleteBtn = document.getElementById('cancel-delete');
				this.alertModal = document.getElementById('alert-modal');
				this.confirmAlertBtn = document.getElementById('confirm-alert');
				this.itemToDelete = null;
				this.deleteType = '';
				this.deleteAction = '';
				this.bindEvents();
			},
			bindEvents() {
				this.confirmDeleteBtn.addEventListener('click', () => this.handleDeleteConfirm());
				this.cancelDeleteBtn.addEventListener('click', () => this.hideDeleteModal());
				this.deleteModal.addEventListener('click', (e) => {
					if (e.target === this.deleteModal) this.hideDeleteModal();
				});
				this.confirmAlertBtn.addEventListener('click', () => {
					this.hideAlertModal();
					if (typeof this.onAlertConfirm === 'function') {
						this.onAlertConfirm();
					}
				});
				this.alertModal.addEventListener('click', (e) => {
					if (e.target === this.alertModal) {
						if (typeof this.onAlertConfirm === 'function') {
							this.onAlertConfirm();
						}
						this.hideAlertModal();
					}
				});

				// å¡å·ç®¡ç†æŒ‰é’®
				document.getElementById('add-card').addEventListener('click', () => {
					if (sendMessage('add_card')) {
						showAlert('è¯·æŠŠå¡ç‰‡æ”¾åœ¨ä¼ æ„Ÿå™¨ä¸Š', 'å–æ¶ˆæ·»åŠ ', () => {
							sendMessage('cancel_add_card');
						});
					}
				});

				document.getElementById('empty-card').addEventListener('click', () => {
					this.showDeleteConfirm('card', null, 'clear');
				});

				document.getElementById('refresh-cards').addEventListener('click', () => {
					if (sendMessage('refresh_cards')) {
						showLoading("æ­£åœ¨åŒæ­¥æ•°æ®...", 500);
					}
				});

				// æŒ‡çº¹ç®¡ç†æŒ‰é’®
				document.getElementById('add-fingerprint').addEventListener('click', () => {
					if (sendMessage('add_fingerprint')) {
						showAlert('è¯·æŠŠæ‰‹æŒ‡æ”¾åœ¨ä¼ æ„Ÿå™¨ä¸Š', 'å–æ¶ˆæ·»åŠ ', () => {
							sendMessage('cancel_add_fingerprint');
						});
					}
				});

				document.getElementById('empty-fingerprint').addEventListener('click', () => {
					this.showDeleteConfirm('fingerprint', null, 'clear');
				});

				document.getElementById('refresh-fingerprints').addEventListener('click', () => {
					if (sendMessage('refresh_fingerprints')) {
						showLoading("æ­£åœ¨åŒæ­¥æ•°æ®...", 500);
					}
				});

				// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åˆ é™¤æŒ‰é’®
				document.getElementById('card-list-container').addEventListener('click', (e) => {
					if (e.target.classList.contains('delete-btn')) {
						const cardNumber = e.target.dataset.id;
						this.showDeleteConfirm('card', cardNumber);
					}
				});

				document.getElementById('fingerprint-list-container').addEventListener('click', (e) => {
					if (e.target.classList.contains('delete-btn')) {
						const templateId = e.target.dataset.id;
						this.showDeleteConfirm('fingerprint', templateId);
					}
				});
			},
			// æ›´æ–°å¡ç‰‡åˆ—è¡¨ï¼ˆä½¿ç”¨DocumentFragmentä¼˜åŒ–æ€§èƒ½ï¼‰
			updateCardList() {
				const container = document.getElementById('card-list-container');
				container.innerHTML = '';

				if (cardData.length === 0) {
					container.innerHTML = `
						<div class="empty-state">
							<i>ğŸ’³</i>
							<p>æš‚æ— å¡ç‰‡æ•°æ®</p>
						</div>
					`;
					return;
				}

				const fragment = document.createDocumentFragment();
				cardData.forEach((card, index) => {
					const item = document.createElement('div');
					item.className = 'list-item';
					item.innerHTML = `
						<div class="content">
							<span>å¡ç‰‡ #${index + 1}</span>
							<span style="font-size: 0.8rem; color: #666;">å¡å·: ${card.cardNumber}</span>
						</div>
						<button class="delete-btn" data-id="${card.cardNumber}">åˆ é™¤</button>
					`;
					fragment.appendChild(item);
				});
				container.appendChild(fragment);
			},
			// æ›´æ–°æŒ‡çº¹åˆ—è¡¨
			updateFingerprintList() {
				const container = document.getElementById('fingerprint-list-container');
				container.innerHTML = '';

				if (fingerprintData.length === 0) {
					container.innerHTML = `
						<div class="empty-state">
							<i>ğŸ‘†</i>
							<p>æš‚æ— æŒ‡çº¹æ•°æ®</p>
						</div>
					`;
					return;
				}

				const fragment = document.createDocumentFragment();
				fingerprintData.forEach((fingerprint, index) => {
					const item = document.createElement('div');
					item.className = 'list-item';
					item.innerHTML = `
						<div class="content">
							<span>æŒ‡çº¹ #${index + 1}</span>
							<span style="font-size: 0.8rem; color: #666;">æ¨¡æ¿ID: ${fingerprint.templateId}</span>
						</div>
						<button class="delete-btn" data-id="${fingerprint.templateId}">åˆ é™¤</button>
					`;
					fragment.appendChild(item);
				});
				container.appendChild(fragment);
			},
			// æ›´æ–°å¡ç‰‡è®¡æ•°
			updateCardCount() {
				const count = cardData.length;
				document.getElementById('card-count').textContent = `${count} å¼ `;
				document.getElementById('home-card-count').textContent = count;
			},
			// æ›´æ–°æŒ‡çº¹è®¡æ•°
			updateFingerprintCount() {
				const count = fingerprintData.length;
				document.getElementById('fingerprint-count').textContent = `${count} æš`;
				document.getElementById('home-fingerprint-count').textContent = count;
			},
			showDeleteConfirm(type, id = null, action = 'delete') {
				this.deleteType = type;
				this.itemToDelete = id;
				this.deleteAction = action;
				const modalText = action === 'clear'
					? `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${type === 'card' ? 'å¡ç‰‡' : 'æŒ‡çº¹'}å—ï¼Ÿ`
					: 'ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ';
				document.querySelector('#delete-modal .modal-content p').textContent = modalText;
				this.deleteModal.style.display = 'flex';
			},
			hideDeleteModal() {
				this.deleteModal.style.display = 'none';
				this.itemToDelete = null;
				this.deleteType = '';
				this.deleteAction = '';
			},
			hideAlertModal() {
				this.alertModal.style.display = 'none';
			},
			handleDeleteConfirm() {
				let message;
				if (this.deleteAction === 'clear') {
					message = this.deleteType === 'card' ? 'clear_cards' : 'clear_fingerprints';
				} else {
					message = this.deleteType === 'card'
						? `delete_card:${this.itemToDelete}`
						: `delete_fingerprint:${this.itemToDelete}`;
				}
				sendMessage(message);
				this.hideDeleteModal();
			}
		};
	</script>
</body>

</html>