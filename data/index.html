<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>ESP32 智能门锁控制中心</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" href="style.css">
</head>

<body>
	<div class="topnav">
		<h1>ESP32 智能门锁控制中心</h1>
	</div>
	<div class="content">
		<!-- 首页页面 -->
		<div id="home-page" class="page-container active">
			<div class="card">
				<div class="icon-box">
					<div class="lock-icon"></div>
				</div>
				<div class="card-title">设备信息</div>
				<div class="status-item">
					<label>指纹数量</label>
					<span class="value" id="home-fingerprint-count"></span>
				</div>
				<div class="status-item">
					<label>卡号数量</label>
					<span class="value" id="home-card-count"></span>
				</div>
				<div class="status-item">
					<label>固件版本</label>
					<span class="value" id="firmware-version"></span>
				</div>
			</div>
		</div>
		<!-- 卡号库页面 -->
		<div id="card-page" class="page-container">
			<div class="card">
				<div class="card-title">卡号库管理</div>
				<div class="status-item">
					<label>已添加卡片</label>
					<span class="value" id="card-count">0 张</span>
				</div>
			</div>
			<div class="btn-group">
				<button class="btn btn-add" id="add-card">
					<i>+</i>添加卡片 </button>
				<button class="btn btn-empty" id="empty-card">
					<i>✕</i>清空卡片 </button>
				<button class="btn btn-refresh" id="refresh-cards">
					<i>↺</i>刷新 </button>
			</div>
			<div class="card">
				<div class="list-container" id="card-list-container">
					<div class="empty-state">
						<i>💳</i>
						<p>暂无卡片数据</p>
					</div>
				</div>
			</div>
		</div>
		<!-- 指纹库页面 -->
		<div id="fingerprint-page" class="page-container">
			<div class="card">
				<div class="card-title">指纹库管理</div>
				<div class="status-item">
					<label>已录入指纹</label>
					<span class="value" id="fingerprint-count">0 枚</span>
				</div>
			</div>
			<div class="btn-group">
				<button class="btn btn-add" id="add-fingerprint">
					<i>+</i>录入指纹 </button>
				<button class="btn btn-empty" id="empty-fingerprint">
					<i>✕</i>清空指纹 </button>
				<button class="btn btn-refresh" id="refresh-fingerprints">
					<i>↺</i>刷新 </button>
			</div>
			<div class="card">
				<div class="list-container" id="fingerprint-list-container">
					<div class="empty-state">
						<i>👆</i>
						<p>暂无指纹数据</p>
					</div>
				</div>
			</div>
		</div>
		<div id="mine-page" class="page-container">
			<div class="card">
				<div class="card-title">系统设置</div>
				<div class="status-item">
					<label>WiFi名称：</label>
					<div class="input-container">
						<input type="text" name="wifi-name" placeholder="仅允许英文或数字" oninput="validateWifiName(this)">
						<span class="validation-message" id="wifi-name-message"></span>
					</div>
				</div>
				<div class="status-item">
					<label>WiFi密码：</label>
					<div class="input-container">
						<input type="text" name="wifi-password" placeholder="仅允许英文或数字，最少8位"
							oninput="validateWifiPassword(this)">
						<span class="validation-message" id="wifi-password-message"></span>
					</div>
				</div>
				<div class="status-item">
					<label>门锁密码：</label>
					<div class="input-container">
						<input type="text" name="lock-password" placeholder="请输入6位数字"
							oninput="validateLockPassword(this)">
						<span class="validation-message" id="lock-password-message"></span>
					</div>
				</div>
				<button class="btn btn-operation" id="save-settings">确认修改</button>
				<button class="btn btn-operation">设备信息</button>
				<button class="btn btn-operation">关于系统</button>
				<div style="height: 12px;"></div>
			</div>
		</div>
	</div>
	<!-- 删除确认弹窗 -->
	<div class="modal" id="delete-modal">
		<div class="modal-content">
			<p>确定要删除该项目吗？</p>
			<div class="modal-buttons">
				<button class="modal-btn modal-confirm" id="confirm-delete">确认</button>
				<button class="modal-btn modal-cancel" id="cancel-delete">取消</button>
			</div>
		</div>
	</div>
	<!-- 提示弹窗 -->
	<div class="modal" id="alert-modal">
		<div class="modal-content">
			<p id="alert-message"></p>
			<div class="modal-buttons"> <button class="modal-btn modal-confirm" id="confirm-alert">确认</button> </div>
		</div>
	</div>
	<!-- 成功弹窗 -->
	<div class="modal" id="success-toast-modal">
		<div class="success-toast-box">
			<div class="success-icon">✓</div>
			<p id="success-message"></p>
		</div>
	</div>
	<!-- 加载中弹窗 -->
	<div class="modal" id="loading-modal">
		<div class="loading-box">
			<div class="loading-spinner"></div>
			<p class="loading-text">加载中...</p>
		</div>
	</div>
	<div class="bottom-nav">
		<a href="javascript:void(0)" class="nav-item active" data-page="home-page">
			<span class="icon">🏠</span>
			<span>首页</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="card-page">
			<span class="icon">💳</span>
			<span>卡号库</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="fingerprint-page">
			<span class="icon">👆</span>
			<span>指纹库</span>
		</a>
		<a href="javascript:void(0)" class="nav-item" data-page="mine-page">
			<span class="icon">👤</span>
			<span>我的</span>
		</a>
	</div>
	<script>
		var gateway = `ws://${window.location.hostname}/ws`;
		var websocket;
		let cardData = [];
		let fingerprintData = [];

		window.addEventListener('load', onLoad);

		function initWebSocket() {
			websocket = new WebSocket(gateway);
			websocket.onopen = onOpen;
			websocket.onclose = onClose;
			websocket.onmessage = onMessage;
		}

		function onOpen(event) {
			console.log('Connection opened');
		}

		function onClose(event) {
			console.log('Connection closed');
			setTimeout(initWebSocket, 2000); // 发布前取消注释
		}

		function onMessage(event) {
			try {
				const data = JSON.parse(event.data);
				console.log('收到ESP32数据:', data);

				switch (data.type) {
					case 'card_list':
						updateCardData(data.data);
						break;
					case 'fingerprint_list':
						updateFingerprintData(data.data);
						break;
					case 'status':
						showSuccessToast(data.message);
						break;
					case 'init_data':
						updateVersion(data.version);
						updateCardData(data.cards);
						updateFingerprintData(data.fingers);
						break;
					case 'operation_result':
						if (data.message == "fingerprint_added") {
							if (data.result) {
								Modal.hideAlertModal();                 // ✅ 成功后关闭提示框
								showSuccessToast('指纹添加成功');      // ✅ 弹出提示
							} else {
								showAlert('指纹添加失败', '好的');
							}
						}
						else if (data.message == "card_added") {
							if (data.result) {
								Modal.hideAlertModal();                 // ✅ 成功后关闭提示框
								showSuccessToast('卡片添加成功');      // ✅ 弹出提示
							} else {
								showAlert('卡片已存在', '好的');
							}
						}
						else if (data.message == "fingerprint_deleted") {
							if (data.result) {
								showSuccessToast('指纹删除成功');
							} else {
								showAlert('指纹删除失败', '好的');
							}
						}
						else if (data.message == "card_deleted") {
							if (data.result) {
								showSuccessToast('卡片删除成功');
							} else {
								showAlert('卡片删除失败', '好的');
							}
						}
						else if (data.message == "fingerprint_cleared") {
							if (data.result) {
								fingerprintData = [];
								Modal.updateFingerprintList();
								Modal.updateFingerprintCount();
								showSuccessToast('指纹清空成功');
							} else {
								showAlert('指纹清空失败', '好的');
							}
						}
						else if (data.message == "card_cleared") {
							if (data.result) {
								cardData = [];
								Modal.updateCardList();
								Modal.updateCardCount();
								showSuccessToast('卡片清空成功');
							} else {
								showAlert('卡片清空失败', '好的');
							}
						}

						break;
					default:
						console.log('未知消息类型:', data.type);
				}

			} catch (error) {
				console.error('消息解析错误:', error);
				showAlert('数据接收错误', '重试');
			}
		}

		function updateVersion(version) {
			document.getElementById('firmware-version').textContent = `v${version}`;	
		}

		function updateCardData(newCards) {
			cardData = newCards;
			Modal.updateCardList();
			Modal.updateCardCount();
		}

		function updateFingerprintData(newFingerprints) {
			fingerprintData = newFingerprints;
			Modal.updateFingerprintList();
			Modal.updateFingerprintCount();
		}

		function onLoad(event) {
			initWebSocket();
			Navigation.init();
			Modal.init();
			document.getElementById('save-settings').addEventListener('click', saveSettings);
		}

		// 验证函数
		function validateWifiName(input) {
			input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
			const messageEl = document.getElementById('wifi-name-message');
			if (input.value.match(/[^A-Za-z0-9]/)) {
				messageEl.textContent = '仅允许输入英文或数字';
				messageEl.style.color = '#e74c3c';
			} else {
				messageEl.textContent = '';
			}
		}

		function validateWifiPassword(input) {
			input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
			const messageEl = document.getElementById('wifi-password-message');
			if (input.value.match(/[^A-Za-z0-9]/)) {
				messageEl.textContent = '仅允许输入英文或数字';
				messageEl.style.color = '#e74c3c';
			} else if (input.value.length > 0 && input.value.length < 8) {
				messageEl.textContent = `还需${8 - input.value.length}位`;
				messageEl.style.color = '#f39c12';
			} else {
				messageEl.textContent = '';
			}
		}

		function validateLockPassword(input) {
			input.value = input.value.replace(/[^0-9]/g, '').slice(0, 6);
			const messageEl = document.getElementById('lock-password-message');
			if (input.value.match(/[^0-9]/)) {
				messageEl.textContent = '仅允许输入数字';
				messageEl.style.color = '#e74c3c';
			} else if (input.value.length > 0 && input.value.length < 6) {
				messageEl.textContent = `还需${6 - input.value.length}位`;
				messageEl.style.color = '#f39c12';
			} else {
				messageEl.textContent = '';
			}
		}

		// 保存设置
		function saveSettings() {
			const wifiName = document.querySelector('input[name="wifi-name"]').value;
			const wifiPassword = document.querySelector('input[name="wifi-password"]').value;
			const lockPassword = document.querySelector('input[name="lock-password"]').value;

			if (wifiName.length === 0) {
				showAlert('WiFi名称不能为空', '好的');
				return;
			}
			if (wifiPassword.length > 0 && wifiPassword.length < 8) {
				showAlert('WiFi密码长度不能少于8位', '好的');
				return;
			}
			if (lockPassword.length >= 0 && lockPassword.length !== 6) {
				showAlert('门锁密码必须是6位数字', '好的');
				return;
			}

			websocket.send(`save_settings:${wifiName},${wifiPassword},${lockPassword}`);
			showSuccessToast('设置已保存');
		}

		// 提示弹窗
		function showAlert(message, buttonText = '确认', onConfirm = null) {
			const alertModal = document.getElementById('alert-modal');
			const alertMessage = document.getElementById('alert-message');
			const confirmButton = document.getElementById('confirm-alert');

			alertMessage.textContent = message;
			confirmButton.textContent = buttonText;
			alertModal.style.display = 'flex';
			Modal.onAlertConfirm = onConfirm;

			confirmButton.onclick = () => {
				alertModal.style.display = 'none';
				if (typeof Modal.onAlertConfirm === 'function') {
					Modal.onAlertConfirm();
				}
			};
		}
		// 成功提示弹窗
		function showSuccessToast(message, duration = 1500) {
			const modal = document.getElementById('success-toast-modal');
			const msgEl = document.getElementById('success-message');
			msgEl.textContent = message;
			modal.style.display = 'flex';

			setTimeout(() => {
				modal.style.display = 'none';
			}, duration);
		}
		// 加载中提示弹窗
		function showLoading(message = "加载中...", duration = 1500) {
			const modal = document.getElementById('loading-modal');
			const msgEl = modal.querySelector('.loading-text');
			msgEl.textContent = message;
			modal.style.display = 'flex';

			setTimeout(() => {
				modal.style.display = 'none';
			}, duration);
		}
		// 页面导航控制
		const Navigation = {
			init() {
				this.navItems = document.querySelectorAll('.nav-item');
				this.pageContainers = document.querySelectorAll('.page-container');
				this.bindEvents();
			},
			bindEvents() {
				this.navItems.forEach(item => {
					item.addEventListener('click', () => this.switchPage(item));
				});
			},
			switchPage(item) {
				const targetPageId = item.getAttribute('data-page');
				this.navItems.forEach(nav => nav.classList.remove('active'));
				item.classList.add('active');
				this.pageContainers.forEach(page => {
					page.classList.toggle('active', page.id === targetPageId);
				});
			}
		};

		// 弹窗控制
		const Modal = {
			init() {
				this.deleteModal = document.getElementById('delete-modal');
				this.confirmDeleteBtn = document.getElementById('confirm-delete');
				this.cancelDeleteBtn = document.getElementById('cancel-delete');
				this.alertModal = document.getElementById('alert-modal');
				this.confirmAlertBtn = document.getElementById('confirm-alert');
				this.itemToDelete = null;
				this.deleteType = '';
				this.deleteAction = '';
				this.bindEvents();
			},
			bindEvents() {
				this.confirmDeleteBtn.addEventListener('click', () => this.handleDeleteConfirm());
				this.cancelDeleteBtn.addEventListener('click', () => this.hideDeleteModal());
				this.deleteModal.addEventListener('click', (e) => {
					if (e.target === this.deleteModal)
						this.hideDeleteModal();
				});
				this.confirmAlertBtn.addEventListener('click', () => this.hideAlertModal());
				this.alertModal.addEventListener('click', (e) => {
					if (e.target === this.alertModal && typeof this.onAlertConfirm === 'function') {
						this.onAlertConfirm();
						this.hideAlertModal();
					}
				});

				// 卡号管理按钮
				document.getElementById('add-card').addEventListener('click', () => {
					websocket.send('add_card');
					showAlert('请把卡片放在传感器上', '取消添加', () => {
						websocket.send('cancel_add_card');
					});
				});

				document.getElementById('empty-card').addEventListener('click', () => {
					this.showDeleteConfirm('card', null, 'clear');
				});

				document.getElementById('refresh-cards').addEventListener('click', () => {
					showLoading("正在同步数据...", 500);
					websocket.send('refresh_cards');

				});

				// 指纹管理按钮
				document.getElementById('add-fingerprint').addEventListener('click', () => {
					websocket.send('add_fingerprint');
					showAlert('请把手指放在传感器上', '取消添加', () => {
						websocket.send('cancel_add_fingerprint');
					});
				});

				document.getElementById('empty-fingerprint').addEventListener('click', () => {
					this.showDeleteConfirm('fingerprint', null, 'clear');
				});

				document.getElementById('refresh-fingerprints').addEventListener('click', () => {
					showLoading("正在同步数据...", 500);
					websocket.send('refresh_fingerprints');
				});
			},
			// 更新卡片列表
			updateCardList() {
				const container = document.getElementById('card-list-container');
				container.innerHTML = '';

				if (cardData.length === 0) {
					container.innerHTML = `
		                <div class="empty-state">
		                    <i>💳</i>
		                    <p>暂无卡片数据</p>
		                </div>
		            `;
					return;
				}

				cardData.forEach((card, index) => {
					const item = document.createElement('div');
					item.className = 'list-item';
					item.innerHTML = `
		                <div class="content">
		                    <span>卡片 #${index + 1}</span>
		                    <span style="font-size: 0.8rem; color: #666;">卡号: ${card.cardNumber}</span>
		                </div>
		                <button class="delete-btn" onclick="Modal.showDeleteConfirm('card', '${card.cardNumber}')">删除</button>
		            `;
					container.appendChild(item);
				});
			},
			// 更新指纹列表
			updateFingerprintList() {
				const container = document.getElementById('fingerprint-list-container');
				container.innerHTML = '';

				if (fingerprintData.length === 0) {
					container.innerHTML = `
		                <div class="empty-state">
		                    <i>👆</i>
		                    <p>暂无指纹数据</p>
		                </div>
		            `;
					return;
				}

				fingerprintData.forEach((fingerprint, index) => {
					const item = document.createElement('div');
					item.className = 'list-item';
					item.innerHTML = `
		                <div class="content">
		                    <span>指纹 #${index + 1}</span>
		                    <span style="font-size: 0.8rem; color: #666;">模板ID: ${fingerprint.templateId}</span>
		                </div>
		                <button class="delete-btn" onclick="Modal.showDeleteConfirm('fingerprint', ${fingerprint.templateId})">删除</button>
		            `;
					container.appendChild(item);
				});
			},
			// 更新卡片计数
			updateCardCount() {
				const count = cardData.length;
				document.getElementById('card-count').textContent = `${count} 张`;
				document.getElementById('home-card-count').textContent = count;
			},
			// 更新指纹计数
			updateFingerprintCount() {
				const count = fingerprintData.length;
				document.getElementById('fingerprint-count').textContent = `${count} 枚`;
				document.getElementById('home-fingerprint-count').textContent = count;
			},
			showDeleteConfirm(type, id = null, action = 'delete') {
				this.deleteType = type;
				this.itemToDelete = id;
				this.deleteAction = action;
				const modalText = action === 'clear'
					? `确定要清空所有${type === 'card' ? '卡片' : '指纹'}吗？`
					: '确定要删除该项目吗？';
				document.querySelector('#delete-modal .modal-content p').textContent = modalText;
				this.deleteModal.style.display = 'flex';
			},
			hideDeleteModal() {
				this.deleteModal.style.display = 'none';
				this.itemToDelete = null;
				this.deleteType = '';
				this.deleteAction = '';
			},
			hideAlertModal() {
				this.alertModal.style.display = 'none';
			},
			handleDeleteConfirm() {
				if (this.deleteAction === 'clear') {
					websocket.send(this.deleteType === 'card' ? 'clear_cards' : 'clear_fingerprints');
				} else {
					if (this.deleteType === 'card') {
						websocket.send(`delete_card:${this.itemToDelete}`);
					} else {
						websocket.send(`delete_fingerprint:${this.itemToDelete}`);
					}
				}
				this.hideDeleteModal();
			}
		};
	</script>
</body>

</html>