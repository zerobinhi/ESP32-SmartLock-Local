<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ESP32 æ™ºèƒ½é—¨é”æ§åˆ¶ä¸­å¿ƒ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="topnav">
        <h1>ESP32 æ™ºèƒ½é—¨é”æ§åˆ¶ä¸­å¿ƒ</h1>
    </div>
    <div class="content">
        <!-- é¦–é¡µé¡µé¢ -->
        <div id="home-page" class="page-container active">
            <div class="card">
                <div class="icon-box">
                    <div class="lock-icon"></div>
                </div>
                <div class="card-title">è®¾å¤‡ä¿¡æ¯</div>
                <div class="status-item">
                    <label>æŒ‡çº¹æ•°é‡</label>
                    <span class="value" id="home-fingerprint-count">0</span>
                </div>
                <div class="status-item">
                    <label>å¡å·æ•°é‡</label>
                    <span class="value" id="home-card-count">0</span>
                </div>
                <div class="status-item">
                    <label>å›ºä»¶ç‰ˆæœ¬</label>
                    <span class="value">v1.2.0</span>
                </div>
            </div>
        </div>
        <!-- å¡å·åº“é¡µé¢ -->
        <div id="card-page" class="page-container">
            <div class="card">
                <div class="card-title">å¡å·åº“ç®¡ç†</div>
                <div class="status-item">
                    <label>å·²æ·»åŠ å¡ç‰‡</label>
                    <span class="value" id="card-count">0 å¼ </span>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-add" id="add-card">
                    <i>+</i>æ·»åŠ å¡ç‰‡
                </button>
                <button class="btn btn-empty" id="empty-card">
                    <i>âœ•</i>æ¸…ç©ºå¡ç‰‡
                </button>
                <button class="btn btn-refresh" id="refresh-cards">
                    <i>â†º</i>åˆ·æ–°
                </button>
            </div>
            <div class="card">
                <div class="list-container" id="card-list-container">
                    <div class="empty-state">
                        <i>ğŸ’³</i>
                        <p>æš‚æ— å¡ç‰‡æ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- æŒ‡çº¹åº“é¡µé¢ -->
        <div id="fingerprint-page" class="page-container">
            <div class="card">
                <div class="card-title">æŒ‡çº¹åº“ç®¡ç†</div>
                <div class="status-item">
                    <label>å·²å½•å…¥æŒ‡çº¹</label>
                    <span class="value" id="fingerprint-count">0 æš</span>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-add" id="add-fingerprint">
                    <i>+</i>å½•å…¥æŒ‡çº¹
                </button>
                <button class="btn btn-empty" id="empty-fingerprint">
                    <i>âœ•</i>æ¸…ç©ºæŒ‡çº¹
                </button>
                <button class="btn btn-refresh" id="refresh-fingerprints">
                    <i>â†º</i>åˆ·æ–°
                </button>
            </div>
            <div class="card">
                <div class="list-container" id="fingerprint-list-container">
                    <div class="empty-state">
                        <i>ğŸ‘†</i>
                        <p>æš‚æ— æŒ‡çº¹æ•°æ®</p>
                    </div>
                </div>
            </div>
        </div>
        <div id="mine-page" class="page-container">
            <div class="card">
                <div class="card-title">ç³»ç»Ÿè®¾ç½®</div>
                <div class="status-item">
                    <label>WiFiåç§°ï¼š</label>
                    <div class="input-container">
                        <input type="text" name="wifi-name" placeholder="ä»…å…è®¸è‹±æ–‡æˆ–æ•°å­—" oninput="validateWifiName(this)">
                        <span class="validation-message" id="wifi-name-message"></span>
                    </div>
                </div>
                <div class="status-item">
                    <label>WiFiå¯†ç ï¼š</label>
                    <div class="input-container">
                        <input type="text" name="wifi-password" placeholder="ä»…å…è®¸è‹±æ–‡æˆ–æ•°å­—ï¼Œæœ€å°‘8ä½"
                            oninput="validateWifiPassword(this)">
                        <span class="validation-message" id="wifi-password-message"></span>
                    </div>
                </div>
                <div class="status-item">
                    <label>é—¨é”å¯†ç ï¼š</label>
                    <div class="input-container">
                        <input type="text" name="lock-password" placeholder="è¯·è¾“å…¥6ä½æ•°å­—"
                            oninput="validateLockPassword(this)">
                        <span class="validation-message" id="lock-password-message"></span>
                    </div>
                </div>
                <button class="btn btn-operation" id="save-settings">ç¡®è®¤ä¿®æ”¹</button>
                <button class="btn btn-operation">è®¾å¤‡ä¿¡æ¯</button>
                <button class="btn btn-operation">å…³äºç³»ç»Ÿ</button>
                <div style="height: 12px;"></div>
            </div>
        </div>
    </div>
    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <p>ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ</p>
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="confirm-delete">ç¡®è®¤</button>
                <button class="modal-btn modal-cancel" id="cancel-delete">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <!-- æç¤ºå¼¹çª— -->
    <div class="modal" id="alert-modal">
        <div class="modal-content">
            <p id="alert-message"></p>
            <div class="modal-buttons">
                <button class="modal-btn modal-confirm" id="confirm-alert">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div class="modal" id="success-toast-modal">
        <div class="modal-content success-content">
            <div class="success-icon">âœ“</div>
            <p id="success-message"></p>
        </div>
    </div>

    <div class="bottom-nav">
        <a href="javascript:void(0)" class="nav-item active" data-page="home-page">
            <span class="icon">ğŸ </span>
            <span>é¦–é¡µ</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="card-page">
            <span class="icon">ğŸ’³</span>
            <span>å¡å·åº“</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="fingerprint-page">
            <span class="icon">ğŸ‘†</span>
            <span>æŒ‡çº¹åº“</span>
        </a>
        <a href="javascript:void(0)" class="nav-item" data-page="mine-page">
            <span class="icon">ğŸ‘¤</span>
            <span>æˆ‘çš„</span>
        </a>
    </div>
    <script>
        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;
        // æ–°å¢ï¼šå­˜å‚¨å¡ç‰‡å’ŒæŒ‡çº¹æ•°æ®çš„æ•°ç»„
        let cardData = [];
        let fingerprintData = [];

        window.addEventListener('load', onLoad);
        function initWebSocket() {
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }
        function onOpen(event) {
            console.log('Connection opened');
        }
        function onClose(event) {
            console.log('Connection closed');
            // setTimeout(initWebSocket, 2000); æš‚æ—¶æ³¨é‡Šï¼Œå‘å¸ƒä¹‹å‰å–æ¶ˆæ³¨é‡Š
        }
        function onMessage(event) {

            const data = JSON.parse(event.data);
            console.log('æ”¶åˆ°ESP32æ•°æ®:', data);
            switch (data.type) {
                case 'card_list':
                    updateCardData(data.data);
                    break;
                case 'fingerprint_list':
                    updateFingerprintData(data.data);
                    break;
                case 'status':
                    showSuccessToast(data.message);
                    break;
                case 'init_data':
                    // åˆå§‹åŒ–æ•°æ®åŒæ­¥
                    updateCardData(data.cards);
                    updateFingerprintData(data.fingers);
                    break;
                default:
                    console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
            }
        }
        function updateCardData(newCards) {
            cardData = newCards;
            Modal.updateCardList();
            Modal.updateCardCount();
        }

        function updateFingerprintData(newFingerprints) {
            fingerprintData = newFingerprints;
            Modal.updateFingerprintList();
            Modal.updateFingerprintCount();
        }
        function onLoad(event) {
            initWebSocket();
            Navigation.init();
            Modal.init();
            // ä¿å­˜è®¾ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('save-settings').addEventListener('click', saveSettings);
        }
        // éªŒè¯WiFiåç§°
        function validateWifiName(input) {
            input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
            const messageEl = document.getElementById('wifi-name-message');
            if (input.value.match(/[^A-Za-z0-9]/)) {
                messageEl.textContent = 'ä»…å…è®¸è¾“å…¥è‹±æ–‡æˆ–æ•°å­—';
                messageEl.style.color = '#e74c3c';
            } else {
                messageEl.textContent = '';
            }
        }
        // éªŒè¯WiFiå¯†ç 
        function validateWifiPassword(input) {
            input.value = input.value.replace(/[^A-Za-z0-9]/g, '');
            const messageEl = document.getElementById('wifi-password-message');
            if (input.value.match(/[^A-Za-z0-9]/)) {
                messageEl.textContent = 'ä»…å…è®¸è¾“å…¥è‹±æ–‡æˆ–æ•°å­—';
                messageEl.style.color = '#e74c3c';
            } else if (input.value.length > 0 && input.value.length < 8) {
                messageEl.textContent = `è¿˜éœ€${8 - input.value.length}ä½`;
                messageEl.style.color = '#f39c12';
            } else {
                messageEl.textContent = '';
            }
        }
        // éªŒè¯é—¨é”å¯†ç 
        function validateLockPassword(input) {
            input.value = input.value.replace(/[^0-9]/g, '').slice(0, 6);
            const messageEl = document.getElementById('lock-password-message');
            if (input.value.match(/[^0-9]/)) {
                messageEl.textContent = 'ä»…å…è®¸è¾“å…¥æ•°å­—';
                messageEl.style.color = '#e74c3c';
            } else if (input.value.length > 0 && input.value.length < 6) {
                messageEl.textContent = `è¿˜éœ€${6 - input.value.length}ä½`;
                messageEl.style.color = '#f39c12';
            } else {
                messageEl.textContent = '';
            }
        }
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const wifiName = document.querySelector('input[name="wifi-name"]').value;
            const wifiPassword = document.querySelector('input[name="wifi-password"]').value;
            const lockPassword = document.querySelector('input[name="lock-password"]').value;
            if
                (wifiName.length === 0) {
                showAlert('WiFiåç§°ä¸èƒ½ä¸ºç©º');
                return;
            }
            if (wifiPassword.length >= 0 && wifiPassword.length < 8) {
                showAlert('WiFiå¯†ç é•¿åº¦ä¸èƒ½å°‘äº8ä½');
                return;
            }
            if (lockPassword.length >= 0 && lockPassword.length !== 6) {
                showAlert('é—¨é”å¯†ç å¿…é¡»æ˜¯6ä½æ•°å­—');
                return;
            }
            websocket.send(`save_settings:${wifiName},${wifiPassword},${lockPassword}`);
            showSuccessToast('è®¾ç½®å·²ä¿å­˜'); // æ”¹ç”¨æˆåŠŸæç¤º
        }
        // æ˜¾ç¤ºæç¤ºå¼¹çª—
        function showAlert(message) {
            const alertModal = document.getElementById('alert-modal');
            const alertMessage = document.getElementById('alert-message');
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
        }
        function showSuccessToast(message) {
            const successModal = document.getElementById('success-toast-modal');
            const successMessage = document.getElementById('success-message');

            successMessage.textContent = message;

            successModal.style.display = 'flex';

            // 3ç§’åè‡ªåŠ¨å…³é—­
            setTimeout(() => {
                successModal.style.display = 'none';
            }, 3000);
        }
        // é¡µé¢å¯¼èˆªæ§åˆ¶
        const Navigation = {
            init() {
                this.navItems = document.querySelectorAll('.nav-item');
                this.pageContainers = document.querySelectorAll('.page-container');
                this.bindEvents();
            },
            bindEvents() {
                this.navItems.forEach(item => {
                    item.addEventListener('click', () => this.switchPage(item));
                });
            },
            switchPage(item) {
                const targetPageId = item.getAttribute('data-page');
                this.navItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');
                this.pageContainers.forEach(page => {
                    page.classList.toggle('active', page.id === targetPageId);
                });
            }
        };
        // å¼¹çª—æ§åˆ¶
        const Modal = {
            init() {
                this.deleteModal = document.getElementById('delete-modal');
                this.confirmDeleteBtn = document.getElementById('confirm-delete');
                this.cancelDeleteBtn = document.getElementById('cancel-delete');
                this.alertModal = document.getElementById('alert-modal');
                this.confirmAlertBtn = document.getElementById('confirm-alert');
                this.itemToDelete = null;
                this.deleteType = '';
                this.deleteAction = '';
                this.bindEvents();
            },
            bindEvents() {
                this.confirmDeleteBtn.addEventListener('click', () => this.handleDeleteConfirm());
                this.cancelDeleteBtn.addEventListener('click', () => this.hideDeleteModal());
                this.deleteModal.addEventListener('click', (e) => {
                    if (e.target === this.deleteModal) this.hideDeleteModal();
                });
                this.confirmAlertBtn.addEventListener('click', () => this.hideAlertModal());
                this.alertModal.addEventListener('click', (e) => {
                    if (e.target === this.alertModal) this.hideAlertModal();
                });
                // å¡å·ç®¡ç†æŒ‰é’® - ä¿®æ”¹æ·»åŠ å¡ç‰‡é€»è¾‘
                document.getElementById('add-card').addEventListener('click', () => {
                    websocket.send('add_card');
                });
                document.getElementById('empty-card').addEventListener('click', () => {
                    this.showDeleteConfirm('card', null, 'clear');
                });
                document.getElementById('refresh-cards').addEventListener('click', () => {
                    websocket.send('refresh_cards');
                });
                // æŒ‡çº¹ç®¡ç†æŒ‰é’® - ä¿®æ”¹æ·»åŠ æŒ‡çº¹é€»è¾‘
                document.getElementById('add-fingerprint').addEventListener('click', () => {
                    websocket.send('add_fingerprint');
                });
                document.getElementById('empty-fingerprint').addEventListener('click', () => {
                    this.showDeleteConfirm('fingerprint', null, 'clear');
                });
                document.getElementById('refresh-fingerprints').addEventListener('click', () => {
                    websocket.send('refresh_fingerprints');
                });
            },
            // æ–°å¢ï¼šæ›´æ–°å¡ç‰‡åˆ—è¡¨æ˜¾ç¤º
            updateCardList() {
                const container = document.getElementById('card-list-container');
                // æ¸…ç©ºå®¹å™¨ï¼ˆä¿ç•™ç©ºçŠ¶æ€åˆ¤æ–­ï¼‰
                container.innerHTML = '';

                if (cardData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i>ğŸ’³</i>
                            <p>æš‚æ— å¡ç‰‡æ•°æ®</p>
                        </div>
                    `;
                    return;
                }

                // éå†å¡ç‰‡æ•°æ®ï¼Œç”¨ç´¢å¼•ç”Ÿæˆè¿ç»­æ˜¾ç¤ºåºå·ï¼ˆidä»1å¼€å§‹ï¼‰
                cardData.forEach((card, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    // æ˜¾ç¤ºåºå·ä¸ºç´¢å¼•+1ï¼Œåˆ é™¤æŒ‰é’®ä¼ å…¥å®é™…å¡å·ï¼ˆcardNumberï¼‰
                    item.innerHTML = `
                <div class="content">
                    <span>å¡ç‰‡ #${index + 1}</span>
                    <span style="font-size: 0.8rem; color: #666;">å¡å·: ${card.cardNumber}</span>
                </div>
                <button class="delete-btn" onclick="Modal.showDeleteConfirm('card', '${card.cardNumber}')">åˆ é™¤</button>
            `;
                    container.appendChild(item);
                });
            },
            // æ–°å¢ï¼šæ›´æ–°æŒ‡çº¹åˆ—è¡¨æ˜¾ç¤º
            updateFingerprintList() {
                const container = document.getElementById('fingerprint-list-container');
                // æ¸…ç©ºå®¹å™¨ï¼ˆä¿ç•™ç©ºçŠ¶æ€åˆ¤æ–­ï¼‰
                container.innerHTML = '';

                if (fingerprintData.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i>ğŸ‘†</i>
                            <p>æš‚æ— æŒ‡çº¹æ•°æ®</p>
                        </div>
                    `;
                    return;
                }

                // éå†æŒ‡çº¹æ•°æ®ï¼Œç”¨ç´¢å¼•ç”Ÿæˆè¿ç»­æ˜¾ç¤ºåºå·ï¼ˆidä»1å¼€å§‹ï¼‰
                fingerprintData.forEach((fingerprint, index) => {
                    const item = document.createElement('div');
                    item.className = 'list-item';
                    // æ˜¾ç¤ºåºå·ä¸ºç´¢å¼•+1ï¼Œåˆ é™¤æŒ‰é’®ä¼ å…¥å®é™…æ¨¡æ¿IDï¼ˆtemplateIdï¼‰
                    item.innerHTML = `
                <div class="content">
                    <span>æŒ‡çº¹ #${index + 1}</span> <!-- æ˜¾ç¤ºåºå·ï¼šè¿ç»­æ’åˆ— -->
                    <span style="font-size: 0.8rem; color: #666;">æ¨¡æ¿ID: ${fingerprint.templateId}</span> <!-- å®é™…æ ‡è¯† -->
                </div>
                <button class="delete-btn" onclick="Modal.showDeleteConfirm('fingerprint', ${fingerprint.templateId})">åˆ é™¤</button>
            `;
                    container.appendChild(item);
                });
            },
            // æ–°å¢ï¼šæ›´æ–°å¡ç‰‡è®¡æ•°æ˜¾ç¤º
            updateCardCount() {
                const count = cardData.length;
                document.getElementById('card-count').textContent = `${count} å¼ `;
                document.getElementById('home-card-count').textContent = count;
            },
            // æ–°å¢ï¼šæ›´æ–°æŒ‡çº¹è®¡æ•°æ˜¾ç¤º
            updateFingerprintCount() {
                const count = fingerprintData.length;
                document.getElementById('fingerprint-count').textContent = `${count} æš`;
                document.getElementById('home-fingerprint-count').textContent = count;
            },
            showDeleteConfirm(type, id = null, action = 'delete') {
                this.deleteType = type;
                this.itemToDelete = id;
                this.deleteAction = action;
                const modalText = action === 'clear'
                    ? `ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰${type === 'card' ? 'å¡ç‰‡' : 'æŒ‡çº¹'}å—ï¼Ÿ`
                    : 'ç¡®å®šè¦åˆ é™¤è¯¥é¡¹ç›®å—ï¼Ÿ';
                document.querySelector('#delete-modal .modal-content p').textContent = modalText;
                this.deleteModal.style.display = 'flex';
            },
            hideDeleteModal() {
                this.deleteModal.style.display = 'none';
                this.itemToDelete = null;
                this.deleteType = '';
                this.deleteAction = '';
            },
            hideAlertModal() {
                this.alertModal.style.display = 'none';
            },
            handleDeleteConfirm() {
                if (this.deleteAction === 'clear') {
                    // æ¸…ç©ºæ‰€æœ‰æ•°æ®
                    if (this.deleteType === 'card') {
                        cardData = [];
                        this.updateCardList();
                        this.updateCardCount();
                        websocket.send('clear_cards'); // é€šçŸ¥ESP32æ¸…ç©ºå¡ç‰‡
                    } else {
                        fingerprintData = [];
                        this.updateFingerprintList();
                        this.updateFingerprintCount();
                        websocket.send('clear_fingerprints'); // é€šçŸ¥ESP32æ¸…ç©ºæŒ‡çº¹
                    }
                    const command = this.deleteType === 'card' ? 'clear_cards' : 'clear_fingerprints';
                    websocket.send(command);
                } else {
                    // åˆ é™¤å•ä¸ªé¡¹ç›®
                    if (this.deleteType === 'card') {
                        cardData = cardData.filter(item => item.cardNumber !== this.itemToDelete);
                        this.updateCardList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆåºå·è‡ªåŠ¨æ›´æ–°ï¼‰
                        this.updateCardCount();
                        websocket.send(`delete_card:${this.itemToDelete}`); // é€šçŸ¥ESP32åˆ é™¤æŒ‡å®šå¡ç‰‡
                    } else {
                        fingerprintData = fingerprintData.filter(item => item.templateId !== this.itemToDelete);
                        this.updateFingerprintList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆåºå·è‡ªåŠ¨æ›´æ–°ï¼‰
                        this.updateFingerprintCount();
                        websocket.send(`delete_fingerprint:${this.itemToDelete}`); // é€šçŸ¥ESP32åˆ é™¤æŒ‡å®šæŒ‡çº¹
                    }
                }
                this.hideDeleteModal();
            }
        };
    </script>
</body>

</html>